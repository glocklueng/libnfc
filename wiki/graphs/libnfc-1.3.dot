digraph nfc_transceive {
    fontname="Bitstream Vera Sans";
    fontsize=10;

    edge [fontname="Bitstream Vera Sans", fontsize=8];
    node [fontname="Bitstream Vera Sans", fontsize=10];

    subgraph {
	node [shape=plaintext];
	library -> chipdriver -> devicedriver -> busdriver -> chip;

	devicedriver	[label="device driver"];
	chipdriver	[label="chip driver"];
	busdriver       [label="bus driver"]
    }

    libnfc	[shape=house];
    PN531	[shape=invhouse];
    PN532	[shape=invhouse];
    PN533	[shape=invhouse];

    USB		[label="PN531_usb"];

    {
	edge [style=dotted];
	UART-> PN532;
	libnfc -> ACR122;
	ACR122 -> PN532;
	libnfc -> USB;
	libnfc -> arygon;
	libnfc -> PN532_uart;
	libnfc -> PN533_usb;
	PN53x -> arygon -> UART;
	PN53x -> PN532_uart -> UART;
	PN53x -> ACR122;
	PN53x -> PN533_usb -> PN533;
    }

    {
	rank=same;
	libnfc;
	library;
    }

    {
	rank=same;
	ACR122;
	USB;
	PN532_uart;
	PN533_usb;
	arygon;
	devicedriver;
    }

    {
	rank=same;
	PN53x;
	chipdriver;
    }

    {
	UART;
	busdriver;
    }

    {
	rank=same
	PN531;
	PN532;
	PN533;
	chip;
    }

    // Send message
    edge [color="#ada7c8"];
    libnfc -> PN53x	[taillabel="1"];
    PN53x -> USB	[taillabel="2"];
    USB -> PN531	[taillabel="3"];

    // Receive ACK/NACK
    edge [color="#887da3"];
    PN531 -> USB	[taillabel="4"];
    USB -> PN53x	[taillabel="5.2.1", style=dashed, color="#df421e"]; // fail
    PN53x -> libnfc	[taillabel="5.2.2", style=dashed, color="#df421e"];

    // Receive response
    edge [color="#625b81"];
    PN531 -> USB	[taillabel="5.1"]; // ok
    USB -> PN53x	[taillabel="6"];

    // Send ACK
    edge [color="#494066"]
    USB -> PN531	[taillabel="7"];
    PN53x -> libnfc	[taillabel="8"];

    label="nfc_transceive() in libnfc-1.3.";
}
